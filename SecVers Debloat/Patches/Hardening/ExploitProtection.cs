using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SecVers_Debloat.Patches.Hardening
{
    public class ExploitProtection
    {
        // Enable DEP (Data Execution Prevention) for all processes
        public void EnableDEPForAllProcesses()
        {
            ExecuteCommand("bcdedit.exe", "/set nx AlwaysOn");
        }

        // Enable SEHOP (Structured Exception Handler Overwrite Protection)
        public void EnableSEHOP()
        {
            SetRegistryValue(@"SYSTEM\CurrentControlSet\Control\Session Manager\kernel",
                "DisableExceptionChainValidation", 0, RegistryValueKind.DWord);
        }

        // Enable Bottom-up ASLR
        public void EnableBottomUpASLR()
        {
            SetRegistryValue(@"SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management",
                "MoveImages", 1, RegistryValueKind.DWord);
        }

        // Enable High-entropy ASLR
        public void EnableHighEntropyASLR()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable ForceRelocateImages,HighEntropy");
        }

        // Enable Mandatory ASLR
        public void EnableMandatoryASLR()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable BottomUp,ForceRelocateImages");
        }

        // Enable Control Flow Guard (CFG)
        public void EnableControlFlowGuard()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable CFG");
        }

        // Enable Validate Exception Chains
        public void EnableValidateExceptionChains()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable SEHOP");
        }

        // Enable Validate Heap Integrity
        public void EnableValidateHeapIntegrity()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable TerminateOnHeapErrors");
        }

        // Block untrusted fonts
        public void BlockUntrustedFonts()
        {
            SetRegistryValue(@"SOFTWARE\Policies\Microsoft\Windows NT\MitigationOptions",
                "MitigationOptions_FontBocking", "1000000000000", RegistryValueKind.String);
        }

        // Enable Code Integrity Guard
        public void EnableCodeIntegrityGuard()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable StrictCFG");
        }

        // Disable Win32k System Calls
        public void DisableWin32kSystemCalls()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable DisableWin32kSystemCalls");
        }

        // Enable Export Address Filtering
        public void EnableExportAddressFiltering()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable FilterExportAddresses");
        }

        // Enable Import Address Filtering
        public void EnableImportAddressFiltering()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable FilterImportAddresses");
        }

        // Block low integrity images
        public void BlockLowIntegrityImages()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable BlockLowLabelImageLoads");
        }

        // Enable Arbitrary Code Guard (ACG)
        public void EnableArbitraryCodeGuard()
        {
            ExecutePowerShell("Set-ProcessMitigation -System -Enable ProhibitDynamicCode");
        }

        private void SetRegistryValue(string path, string name, object value, RegistryValueKind kind)
        {
            try
            {
                using (RegistryKey key = Registry.LocalMachine.CreateSubKey(path))
                {
                    key?.SetValue(name, value, kind);
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Registry error: {ex.Message}");
            }
        }

        private void ExecutePowerShell(string command)
        {
            ProcessStartInfo psi = new ProcessStartInfo
            {
                FileName = "powershell.exe",
                Arguments = $"-NoProfile -ExecutionPolicy Bypass -Command \"{command}\"",
                UseShellExecute = false,
                CreateNoWindow = true,
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                Verb = "runas"
            };

            using (Process process = Process.Start(psi))
            {
                process?.WaitForExit();
            }
        }

        private void ExecuteCommand(string fileName, string arguments)
        {
            ProcessStartInfo psi = new ProcessStartInfo
            {
                FileName = fileName,
                Arguments = arguments,
                UseShellExecute = false,
                CreateNoWindow = true,
                Verb = "runas"
            };

            using (Process process = Process.Start(psi))
            {
                process?.WaitForExit();
            }
        }
    }
}
